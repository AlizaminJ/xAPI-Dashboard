<html>
<head>
	<script src="d3.v3.min.js"></script>
	<script src="nvd3/nv.d3.js"></script>
	<link rel='stylesheet' href='nvd3/nv.d3.css'></link>

	<script type="text/javascript" src="xAPIWrapper/xapiwrapper.min.js"></script>
	<script type="text/javascript" src="collection.js"></script>
	<script type="text/javascript" src="dashboard.js"></script>

	<style>
		#graphContainer > div{
			width: 800px; height: 500px;
			min-width: 100px; min-height: 100px;
			margin: 20px;
		}
		h1 {
			text-align: center;
		}
	</style>

	<script type="text/javascript">
		var wrapper = ADL.XAPIWrapper;
		var xAPIConf = {
			"endpoint" : 'http://12.109.40.37/xAPI/',
		};
				
		wrapper.changeConfig(xAPIConf);
		var dash1 = new ADL.XAPIDashboard(),
			dash2 = new ADL.XAPIDashboard(),
			set = ADL.Collection;

		window.onload = function(){
			
			dash1.fetchAllStatements({'verb': 'http://vwf.adlnet.gov/xapi/verbs/logged_in'}, function(){
				dash1.genBarGraph("#graphContainer #logins svg", {
					groupField: "object.id", 
					labelField: "object.definition.name.en-US",
					pre: function(data){
							// take the raw xapi data
							return data
								// and then remove
								.without(
									// the statements whose object id is virtual_world_sandbox
									data.selectEqual('object.id', 'http://vwf.adlnet.gov/xapi/virtual_world_sandbox')
								);
						},
					post: function(data){
							// sort by height, and limit to 15 bars
							return data
								.orderBy('result.count', 'descending')
								.select(set.first(15));
						},
					customize: function(chart){
							chart
								.tooltips(true)
								.showValues(false)
								.staggerLabels(false)
								.margin({bottom: 150});

							chart.xAxis
								.rotateLabels(45);

							chart.yAxis.tickFormat(d3.format(',d'));

							chart.discretebar.dispatch.on('elementClick', function(e){
								if(confirm('Go to '+e.point.result.sample.object.definition.moreInfo+'?')){
									window.location.assign(e.point.result.sample.object.definition.moreInfo);
								}
							});

						}
				});
			});

			dash2.fetchAllStatements({'verb': 'http://adlnet.gov/expapi/verbs/registered', 'ascending': true}, function(){
				dash2.genLineGraph('#graphContainer #registrations svg', {
					xAxisField: 'timestamp', 
					post: function(data){
						// 441 users as of first track
						data.transform(function(e){
							e.x = new Date(Date.parse(e.x));
							e.y = e.y + 441;
							return e;
						});
						return data;
					},
					customize: function(chart){
						chart.xAxis.tickFormat(function(d){ return d3.time.format('%b %d')(new Date(d)) });
						chart.forceY([0,500]);
					}
				});
			});

		};
	</script>
</head>
<body>
	<div id='graphContainer'>
		<div id='logins'>
			<h1>Total Logins To Popular Worlds</h1>
			<svg></svg>
		</div>
		<div id='registrations'>
			<h1>New Registrations Over  Time</h1>
			<svg></svg>
		</div>
	</div>
</body>
</html>
