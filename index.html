<html>
<head>
	<script src="nvd3/lib/d3.v3.js"></script>
	<script src="nvd3/nv.d3.js"></script>
	<link rel='stylesheet' href='nvd3/nv.d3.css'></link>

	<script type="text/javascript" src="xAPIWrapper/xapiwrapper.min.js"></script>
	<script type="text/javascript" src="set.js"></script>
	<script type="text/javascript" src="dashboard.js"></script>

	<style>
		#graphContainer > div{
			width: 800px; height: 500px;
			min-width: 100px; min-height: 100px;
			margin: 20px;
		}
	</style>

	<script type="text/javascript">
		var wrapper = ADL.XAPIWrapper,
			dash = new ADL.XAPIDashboard();
			
		var xAPIConf = {
			"endpoint" : 'http://12.109.40.37/xAPI/',
			"user": 'lrsuser',
			"password": 'The only thing we have to fear'
		};
				
		wrapper.changeConfig(xAPIConf);
		window.onload = function(){
			
			dash.fetchAllStatements({'verb': 'http://vwf.adlnet.gov/xapi/verbs/logged_in'}, function(){
				dash.genCountGraph("#graphContainer #logins svg", "object.id", "object.definition.name.en-US",
					// preprocess
					function(data){
						// use only logged_in events where the id is not virtual_world_sandbox
						return data.selectEqual('verb.id', 'http://vwf.adlnet.gov/xapi/verbs/logged_in')
							.without( data.selectEqual('object.id', 'http://vwf.adlnet.gov/xapi/virtual_world_sandbox') );
					},
					// postprocess
					function(data){
						// sort by height, and limit to 15 bars
						return data.orderBy('result.count', 'descending').select(function(e,i){return i<15});
					},
					// customize
					function(chart){
						chart
							.tooltips(true)
							.showValues(false)
							.margin({top: 50, bottom: 100});

						chart.xAxis
							.rotateLabels(45);

						chart.yAxis.tickFormat(d3.format(',d'));

						// add a title
						d3.select('#graphContainer #logins svg')
							.append('text')
							.attr('text-anchor', 'middle')
							.attr('x', '50%')
							.attr('y', '25px')
							.style('font-size', '20pt')
							.text('Total Logins Per World');
					}
				);

			});

			dash.fetchAllStatements({'verb': 'http://adlnet.gov/expapi/verbs/registered', 'ascending': true}, function(){
				dash.genSumGraph('#graphContainer #registrations svg', 'timestamp', null,
					function(data){
						return data.selectEqual('verb.id', 'http://adlnet.gov/expapi/verbs/registered');
					},
					function(data){
						data.transform(function(e){
							e.x = new Date(Date.parse(e.x));
							return e;
						});
						//console.log(data.transform(Set.getValue('independent')).contents);
						return data;
					},
					function(chart){
						chart.options({'margin': {'top': 50}});

						chart.xAxis.tickFormat(function(d){ return d3.time.format('%b %d')(new Date(d)) });

						// add a title
						d3.select('#graphContainer #registrations svg')
							.append('text')
							.attr('text-anchor', 'middle')
							.attr('x', '50%')
							.attr('y', '25px')
							.style('font-size', '20pt')
							.text('New Registrations Over Time');
					}
				);
			});

		};
	</script>
</head>
<body>
	<div id='graphContainer'>
		<div id='logins'>
			<svg></svg>
		</div>
		<div id='registrations'>
			<svg></svg>
		</div>
	</div>
</body>
</html>
