<html>
<head>
	<link rel='stylesheet' href='lib/nv.d3.css'></link>
	<script type="text/javascript" src="dist/xapidashboard.min.js"></script>

	<style>
		#graphContainer > div{
			width: 800px; height: 500px;
			min-width: 100px; min-height: 100px;
			margin: 20px;
		}
		h1 {
			text-align: center;
		}
		#registrations .nvd3 .nv-series-0 circle {
			fill-opacity: 1;
		}
	</style>

	<script src='extra/lrs-data.js'></script>

	<script type="text/javascript">
		var wrapper = new XAPIWrapper({
			"endpoint" : 'https://lrs.adlnet.gov/xAPI/',
		});
		var dash = new ADL.XAPIDashboard(),
			set = ADL.Collection;

		window.onload = function(){
		
			function generateGraphs()
			{
				dash.genBarGraph("#graphContainer #verbs svg", {
					groupField: "verb.id", 
					post: function(data){
						return data
							// sort by height, and limit to 15 bars
							.orderBy('out', 'descending')
							.select(set.first(10));
					},
					customize: function(chart){
						chart
							.tooltips(true)
							.tooltipContent(function(key,x,y,e,chart){
								return '<h3>'
									+e.point.sample.verb.id
									+'</h3><p>'
									+y
									+'</p>';
							})
							.showValues(false)
							.staggerLabels(false)
							.color(['#1f77b4'])
							.margin({bottom: 150});

						chart.xAxis
							.rotateLabels(45);
						chart.xAxis
							.tickFormat(function(d){ return /[^\/]+$/.exec(d)[0]; });

						chart.yAxis.tickFormat(d3.format(',d'));

						/*chart.discretebar.dispatch.on('elementClick', function(e){
							if(confirm('Go to '+e.point.result.sample.object.definition.moreInfo+'?')){
								window.open(e.point.result.sample.object.definition.moreInfo, '_blank');
							}
						});*/

					}
				});
				
				dash.genLineGraph('#graphContainer #registrations svg', {
					xField: 'timestamp',
					range: {
						start: dash.statements.min("timestamp"),
						end: dash.statements.max("timestamp")
					},
					aggregate: ADL.XAPIDashboard.countRange,
					/* aggregate: ADL.XAPIDashboard.accumulate,
					aggregate: function(statements,opts){
						var start = statements.contents[0].timestamp,
							end = statements.contents[statements.contents.length-1].timestamp;
						var range = ADL.Collection.genRange(start,end, 1000*60*60*24);
						var test = statements.groupByRange('timestamp', range, function(group){
							return group.count();
						});
						return test;
					}, 
					post: function(data){
						return data.transform(function(e){
							e.in = parseInt(e.in.split(',')[0]);
							return e;
						});
					},*/
					customize: function(chart){
						chart.xAxis.tickFormat(function(d){ return d3.time.format('%b %d')(new Date(d)) });
						chart.interpolate('monotone').showLegend(false);
					}
				});
			}

			if( window.statements ){
				dash.addStatements(window.statements);
				generateGraphs();
			}
			else {
				dash.fetchAllStatements({'since': new Date(Date.now() - 1000*60*60*24*30).toISOString()}, wrapper, generateGraphs);
			}
		};
	</script>
</head>
<body>
	<div id='graphContainer'>
		<div id='verbs'>
			<h1>Most Popular Verbs of the Last 30 Days</h1>
			<svg></svg>
		</div>
		<div id='registrations'>
			<h1>New Statements Per Day</h1>
			<svg></svg>
		</div>
	</div>
</body>
</html>
